<script>
    // Initialize charts
    function initializeCharts() {
        // Weekly Trend Chart
        const weeklyCtx = document.getElementById('weeklyTrendChart').getContext('2d');
        new Chart(weeklyCtx, {
            type: 'line',
            data: {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                datasets: [{
                    label: 'Views',
                    data: [8500, 9200, 10800, 12340],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.1
                }, {
                    label: 'Engagement',
                    data: [890, 1120, 1340, 1580],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // Audience Segment Chart
        const audienceCtx = document.getElementById('audienceSegmentChart').getContext('2d');
        new Chart(audienceCtx, {
            type: 'pie',
            data: {
                labels: ['Highly Engaged', 'Casual Viewers'],
                datasets: [{
                    data: [1240, 7520],
                    backgroundColor: ['#10b981', '#6b7280'],
                    hoverBackgroundColor: ['#059669', '#4b5563']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    // Menu navigation functionality
    function switchMenu(menuName) {
        // For demo purposes, just show an alert
        if (menuName !== 'analytics') {
            alert(`Navigating to ${menuName.charAt(0).toUpperCase() + menuName.slice(1)} section`);
        }
    }

    function toggleAnalytics() {
        const submenu = document.getElementById('analytics-submenu');
        submenu.style.display = submenu.style.display === 'none' ? 'block' : 'none';
    }

    function switchAnalyticsTab(tabName) {
        if (tabName === 'summary') {
            // Already on summary page
            return;
        } else if (tabName === 'viewers') {
            // Navigate to viewers page
            window.location.href = 'viewers-analytics.html';
        } else if (tabName === 'videos') {
            // Navigate to videos page
            window.location.href = 'videos-analytics.html';
        } else if (tabName === 'engagement') {
            // Navigate to engagement page
            window.location.href = 'engagement-analytics.html';
        }
    }

    // Download functionality
    function convertToCSV(data, headers) {
        const csvHeaders = headers.join(',');
        const csvRows = data.map(row => 
            headers.map(header => {
                const value = row[header];
                if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
                    return `"${value.replace(/"/g, '""')}"`;
                }
                return value;
            }).join(',')
        );
        return [csvHeaders, ...csvRows].join('\n');
    }

    function downloadCSV(csvContent, filename) {
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
    }

    function downloadSurveyData() {
        const surveyData = [
            { videoTitle: "Introduction to Product Strategy", question: "How useful was this content?", answer: "Very useful", responseType: "survey", submittedAt: "2024-06-15T10:30:00Z", userSegment: "highly_engaged" },
            { videoTitle: "Introduction to Product Strategy", question: "Rate your understanding (1-5)", answer: "4", responseType: "poll", submittedAt: "2024-06-15T11:15:00Z", userSegment: "casual_viewer" },
            { videoTitle: "Advanced Analytics Deep Dive", question: "Which analytics method do you prefer?", answer: "Cohort analysis", responseType: "quiz", submittedAt: "2024-06-16T09:20:00Z", userSegment: "highly_engaged" },
            { videoTitle: "Customer Interview Techniques", question: "Have you applied these techniques?", answer: "Yes, immediately", responseType: "survey", submittedAt: "2024-06-16T14:45:00Z", userSegment: "highly_engaged" },
            { videoTitle: "Market Research Fundamentals", question: "What's your biggest research challenge?", answer: "Finding qualified participants", responseType: "survey", submittedAt: "2024-06-17T08:10:00Z", userSegment: "casual_viewer" }
        ];
        
        const headers = ['videoTitle', 'question', 'answer', 'responseType', 'submittedAt', 'userSegment'];
        const csvContent = convertToCSV(surveyData, headers);
        const timestamp = new Date().toISOString().split('T')[0];
        downloadCSV(csvContent, `survey-poll-responses-${timestamp}.csv`);
    }

    function downloadVideoPerformance() {
        const videoData = [
            { title: "Introduction to Product Strategy", views: 2340, engagementScore: 1580, trend: "up" },
            { title: "Advanced Analytics Deep Dive", views: 1890, engagementScore: 1420, trend: "up" },
            { title: "Customer Interview Techniques", views: 1650, engagementScore: 1280, trend: "down" },
            { title: "Market Research Fundamentals", views: 1420, engagementScore: 980, trend: "up" },
            { title: "Competitive Analysis Workshop", views: 1250, engagementScore: 760, trend: "stable" }
        ];
        
        const headers = ['title', 'views', 'engagementScore', 'trend'];
        const csvContent = convertToCSV(videoData, headers);
        const timestamp = new Date().toISOString().split('T')[0];
        downloadCSV(csvContent, `video-performance-${timestamp}.csv`);
    }

    function downloadFullReport() {
        const reportData = [{
            reportDate: new Date().toISOString().split('T')[0],
            timeRange: document.getElementById('timeRange').value,
            totalViews: 12340,
            uniqueViewers: 8760,
            accumulatedWatchTime: 45680,
            avgWatchTime: 5.2,
            engagementRate: 24.3,
            completionRate: 68.5,
            returnViewerRate: 42.1
        }];
        
        const headers = ['reportDate', 'timeRange', 'totalViews', 'uniqueViewers', 'accumulatedWatchTime', 'avgWatchTime', 'engagementRate', 'completionRate', 'returnViewerRate'];
        const csvContent = convertToCSV(reportData, headers);
        const timestamp = new Date().toISOString().split('T')[0];
        downloadCSV(csvContent, `analytics-report-${timestamp}.csv`);
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initializeCharts();
    });
</script>